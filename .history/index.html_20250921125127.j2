<!doctype html>
<html lang="en" data-theme="light">
<head>
  {% set STATIC = static_base or './static/' %}
  <meta charset="utf-8" />
  <title>{{ site_title or "Torchborne" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="index,follow" />
  <meta name="description" content="Poetry & musings by Dami." />
  <meta name="color-scheme" content="light dark" />
  <meta id="themeColorMeta" name="theme-color" content="#f59e0b" />
  <link rel="canonical" href="{{ public_url or '' }}" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://api.rss2json.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="preload" as="style" href="{{ STATIC }}styles.css">
  <link id="mainCss" rel="stylesheet" href="{{ STATIC }}styles.css">
  <noscript><link rel="stylesheet" href="{{ STATIC }}styles.css"></noscript>

  <link rel="alternate" type="application/rss+xml" title="{{ site_title or 'Feed' }}" href="{{ feed_url }}" />
  <link rel="icon" type="image/png" sizes="64x64" href="{{ STATIC }}logo-light.png">

  <!-- Open Graph -->
  <meta property="og:title" content="{{ site_title or 'Torchborne' }}" />
  <meta property="og:description" content="Poetry & musings by Dami." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="{{ public_url or '' }}" />
  <meta property="og:image" content="{{ STATICPUB ~ 'logo-light.svg' }}" />
  <meta property="og:site_name" content="{{ site_title or 'Torchborne' }}" />
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="{{ STATICPUB ~ 'logo-light.svg' }}" />

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"CollectionPage",
    "name": {{ (site_title or "Torchborne") | tojson }},
    "description":"Poetry & musings by Dami.",
    "url": {{ (public_url or '') | tojson }}
  }
  </script>

  <!-- Relaxed CSP for this static setup -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src 'self' https: data:;
    style-src 'self' 'unsafe-inline' https:;
    font-src https:;
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
    connect-src 'self' https:;
    base-uri 'self';
    form-action 'self';
    upgrade-insecure-requests
  ">
</head>
<body>
  <a href="#postsGrid" class="visually-hidden" id="skipLink">Skip to posts</a>
  <div id="noJsBanner" class="status error" role="alert" hidden>JavaScript is disabled. Some features (search, quick read) won't work. You can still read directly on Substack via the links below.</div>
  <noscript>
    <style>
      #noJsBanner,
      #noJsBanner[hidden] {
        display: block !important;
      }
    </style>
  </noscript>

  <!-- Floating Shapes -->
  <div class="floating-shapes" aria-hidden="true">
    <div class="shape accent"></div>
    <div class="shape accent-2"></div>
    <div class="shape accent-3"></div>
  </div>

  <!-- Particles -->
  <div class="particles" id="particles" aria-hidden="true"></div>

  <!-- Progress Bar -->
  <div class="progress-bar" id="progressBar" role="progressbar" aria-live="off" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>

  <div id="appRoot" class="main-content" aria-hidden="false">
    <!-- HERO -->
    <section class="hero">
      <div class="wrap">
        <div class="hero-content">
          <div class="brand-section">
            <a href="./" class="brand-link">
              <img src="{{ STATIC }}logo-light.svg" alt="Torchborne logo" class="logo-img logo-light" fetchpriority="high" width="64" height="64" />
              <img src="{{ STATIC }}logo-dark.svg" alt="Torchborne logo" class="logo-img logo-dark" fetchpriority="high" width="64" height="64" />
              <h1 class="brand-name">{{ site_title or "Torchborne" }}</h1>
            </a>
            <div class="hero-tagline" aria-live="polite">where words carry the flame ‚ú®</div>
          </div>

          <div class="hero-actions">
            <button id="themeToggle" class="chip accent" title="Toggle theme" aria-pressed="false">
              <span id="themeIcon" aria-hidden="true">üåì</span> <span id="themeText">Theme</span>
            </button>
            <button id="refreshBtn" class="chip accent" title="Refresh posts">‚Üª Refresh</button>
            <button id="randomBtn" class="chip accent" title="Surprise me"><span>üé≤</span> Random</button>
            <button id="aboutBtn" class="btn" title="About" aria-haspopup="dialog" aria-controls="aboutModal">
              <span>üëã</span> About
            </button>
            {% if featured_ebook %}
            <a class="btn" href="{{ featured_ebook.url }}" target="_blank" rel="noopener">
              {{ featured_ebook.ctaText or 'Read eBook' }}
            </a>
            {% endif %}
            <a class="btn btn-primary" href="{{ SUBSCRIBE_URL }}" rel="noopener">
              <span>üíå</span> Subscribe
            </a>
          </div>

          <div class="search-section">
            <div class="search-wrapper">
              <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M21 21l-4.35-4.35M10.5 18A7.5 7.5 0 1010.5 3a7.5 7.5 0 000 15z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
              <input id="searchInput" type="search" class="search-input" placeholder="Search through poems and musings..." aria-label="Search poems" />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- MAIN CONTENT -->
    <main class="content">
      <div class="wrap">
        <div id="statusMessage" class="status" role="status" aria-live="polite"{% if posts %} hidden{% endif %}>
          {% if not posts %}Gathering poems from the digital ether...{% endif %}
        </div>
        <section id="postsGrid" class="posts-grid"{% if not posts %} hidden{% endif %}>
          {% if posts %}
            {% set accent_classes = ['accent', 'accent-2', 'accent-3'] %}
            {% for post in posts[:9] %}
              {% set slug = post.slug or '' %}
              {% set candidate_url = post.url or post.link %}
              {% set post_url = candidate_url if candidate_url else (POSTS_BASE ~ '/p/' ~ slug if slug else POSTS_BASE) %}
              {% set iso_date = post.date or post.pubDate or post.published_at %}
              {% set accent = accent_classes[loop.index0 % (accent_classes | length)] %}
              {% set card_title = post.title if post.title else (slug.replace('-', ' ') if slug else 'Untitled') %}
              <article class="card {{ accent }}" data-post-slug="{{ slug }}">
                <div class="card-thumb" aria-hidden="true"></div>
                <div class="card-content">
                  <h2 class="card-title"><a href="{{ post_url }}" target="_blank" rel="noopener">{{ card_title }}</a></h2>
                  <div class="card-meta">
                    {% if display_date %}<span>üìÖ {{ display_date }}</span>{% endif %}
                  </div>
                  <div class="card-summary">{{ post.excerpt or post.description or '' }}</div>
                  <div class="card-actions">
                    <a href="{{ post_url }}" target="_blank" rel="noopener">Read on Substack ‚Üí</a>
                  </div>
                </div>
              </article>
            {% endfor %}
          {% endif %}
        </section>
        <button id="loadMore" class="chip accent" style="display:none; margin: 24px auto 0;" aria-controls="postsGrid">Load older</button>
      </div>
    </main>

    <!-- FOOTER -->
    <footer class="footer">
      <div class="wrap">
        <div class="footer-content">
          <div class="footer-brand">
            <img src="{{ STATIC }}logo-light.svg" class="footer-logo logo-light" alt="" aria-hidden="true" width="32" height="32">
            <img src="{{ STATIC }}logo-dark.svg" class="footer-logo logo-dark" alt="" aria-hidden="true" width="32" height="32">
            <div class="footer-info">
              <h3>{{ site_title or "Torchborne" }}</h3>
              <div class="footerCopyright">¬© {{ generated_at.strftime("%Y") if generated_at else "2024" }} ‚Ä¢ Made with ‚ù§Ô∏è and pixels</div>
            </div>
          </div>

          <nav class="footer-links" aria-label="Footer">
            <a href="#" id="footerAboutLink" class="pill">About</a>
            <a href="{{ SUBSCRIBE_URL }}" class="pill">Subscribe</a>
            <a href="{{ POSTS_BASE }}" target="_blank" rel="noopener" class="pill">
              <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                <path fill="currentColor" d="M3 5h18v2H3V5zm0 4h18v6l-9-3-9 3V9z"/>
              </svg>
              Substack
            </a>
          </nav>
        </div>
      </div>
    </footer>
  </div>

  <!-- READING MODAL -->
  <div id="readingModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalBody" tabindex="-1" hidden>
    <div class="modal-content">
      <button class="modal-close" id="readingModalClose" aria-label="Close">‚úï</button>
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle"></h2>
        <div class="modal-meta" id="modalMeta"></div>
        <div class="modal-actions">
          <button id="prevPost" class="chip accent" title="Previous (‚Üê)">‚Üê Prev</button>
          <button id="nextPost" class="chip accent" title="Next (‚Üí)">Next ‚Üí</button>
        </div>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- ABOUT MODAL -->
  <div id="aboutModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="aboutTitle" tabindex="-1" hidden>
    <div class="modal-content">
      <button class="modal-close" id="aboutModalClose" aria-label="Close about">‚úï</button>
      <div class="modal-header">
        <div class="about-header">
          <img class="about-avatar" src="{{ STATIC }}avatar.jpg" alt="Torchborne" onerror="this.src='{{ STATIC }}logo-light.svg'">
          <div class="about-info">
            <h2 id="aboutTitle">About Torchborne</h2>
            <p class="about-tagline">Illuminating poetry, carrying the flame of words ‚ú®</p>
          </div>
        </div>

        <div class="about-body">
          <p>Welcome to my little corner of the internet where I explore the tender spaces between thoughts and feelings. Here you'll find poems, musings, and little sparks of inspiration that dance through everyday moments.</p>
          <p>I believe poetry lives in the smallest gestures‚Äîthe way light falls across a page, the pause between heartbeats, the stories we tell ourselves in the quiet hours. This collection gathers my public posts from Substack, made searchable and beautiful for wandering souls like yourself.</p>
        </div>

        <div class="about-cta">
          <a class="btn btn-primary" href="{{ SUBSCRIBE_URL }}" rel="noopener">
            <span>üíå</span> Subscribe on Substack
          </a>
          <button id="copyEmailBtn" class="btn" data-email="versesvibez@substack.com">
            <span>üìß</span> Copy Email
          </button>
        </div>

        <div class="about-links">
          <a href="{{ POSTS_BASE }}" target="_blank" rel="noopener" class="pill">
            <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
              <path fill="currentColor" d="M3 5h18v2H3V5zm0 4h18v6l-9-3-9 3V9z"/>
            </svg>
            Substack
          </a>
          <a href="mailto:versesvibez@substack.com" class="pill">
            <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
              <path fill="currentColor" d="M20 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 01-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
            </svg>
            Email
          </a>
          <a href="https://instagram.com/versesvibez" target="_blank" rel="noopener" class="pill">
            <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
              <path fill="currentColor" d="M7 2h10a5 5 0 015 5v10a5 5 0 01-5 5H7a5 5 0 01-5-5V7a5 5 0 015-5zm5 5a5 5 0 100 10 5 5 0 000-10zm6.5-.9a1.1 1.1 0 110 2.2 1.1 1.1 0 010-2.2zM12 9a3 3 0 110 6 3 3 0 010-6z"/>
            </svg>
            Instagram
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- DOMPurify for robust sanitization -->
  <script id="initialPostsData" type="application/json">{{ (posts or []) | tojson }}</script>
  <script
    src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"
    integrity="sha384-OLBgp1GsljhM2TJ+sbHjaiH9txEUvgdDTAzHv2P24donTt6/529l+9Ua0vFImLlb"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>

  <script>
    // ===== CONFIG =====
    const RSS_URL        = {{ (feed_url or "https://versesvibez.substack.com/feed") | tojson }};
    let   WORKER_BASE    = {{ (rss_proxy_url or "") | tojson }};
    const RSS2JSON_KEY   = {{ (rss2json_api_key or "") | tojson }};
    const MAX_ITEMS      = {{ (max_items or 50) | tojson }};
    const PUBLIC_BASE    =
      "https://api.rss2json.com/v1/api.json?"
      + (RSS2JSON_KEY ? ("api_key=" + encodeURIComponent(RSS2JSON_KEY) + "&") : "")
      + "count=" + encodeURIComponent(MAX_ITEMS) + "&rss_url=";
    const FEATURED_EBOOK = {{ (featured_ebook or {}) | tojson }};
    const TAGLINES = [
      "where words carry the flame ‚ú®",
      "poetry for wandering souls ‚úçÔ∏è",
      "verses that glow in the dark üåô"
    ];
    const SUBSTACK_BASE = {{ POSTS_BASE | tojson }};
    const STATIC_DATA_URL = './data/posts.json';

    function normalizeBase(base) {
      if (!base) return "";
      const hasParam = /[?&]rss_url=/.test(base);
      if (hasParam) return base;
      const hasQuery = base.includes("?");
      if (!hasQuery) return base + "?rss_url=";
      if (!/[&?]$/.test(base)) base += "&";
      return base + "rss_url=";
    }
    WORKER_BASE = normalizeBase(WORKER_BASE);

    const CLEAN_SUBSTACK_BASE = SUBSTACK_BASE.replace(/\/$/, '');

    /* ... (rest of your JS stays unchanged) ... */
  </script>
  <!-- Keep the rest of your JS exactly as you provided -->
  {{- "" -}}
</body>
</html>
