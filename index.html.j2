<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>{{ site_title or "versesvibez" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="index,follow" />
  <meta name="description" content="Poetry & musings by Dami." />
  <link rel="alternate" type="application/rss+xml" title="{{ site_title or 'Feed' }}" href="{{ feed_url }}" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Fraunces:opsz,wght@9..144,600;9..144,800&display=swap" rel="stylesheet">
  <link rel="icon" href="static/logo-light.png" />

  <style>
    /* ---------- THEME TOKENS ---------- */
    :root{
      --bg:#faf7f3; --paper:#fffdfa; --ink:#1f2937; --muted:#6b7280;
      --accent:#e56aa6; --accent-2:#6aa6e5; --accent-3:#98d6a6;
      --border:rgba(15,23,42,.12);
      --shadow:0 10px 30px rgba(30,30,30,.06), 0 2px 10px rgba(30,30,30,.04);
      --grain: radial-gradient(1200px 600px at 10% -10%, rgba(229,106,166,.12), transparent 60%),
               radial-gradient(1200px 600px at 90% 0%, rgba(106,166,229,.12), transparent 60%);
    }
    [data-theme="dark"]{
      --bg:#0b0c10; --paper:#0f1117; --ink:#e6edf3; --muted:#93a0b3;
      --accent:#ff9bd2; --accent-2:#8ab4ff; --accent-3:#7ee787;
      --border:rgba(255,255,255,.10);
      --shadow:0 10px 30px rgba(0,0,0,.28), 0 2px 10px rgba(0,0,0,.18);
      --grain: radial-gradient(1200px 600px at 10% -10%, rgba(138,180,255,.12), transparent 60%),
               radial-gradient(1200px 600px at 90% 0%, rgba(255,155,210,.12), transparent 60%);
    }

    /* ---------- BASE ---------- */
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); background:var(--bg);
      background-image: var(--grain);
      font:17px/1.75 Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    *{box-sizing:border-box}
    a{color:inherit; text-decoration-color: rgba(229,106,166,.5); text-underline-offset:2px}
    [data-theme="dark"] a{ text-decoration-color: rgba(255,155,210,.5) }
    a:hover{ text-decoration-color: var(--accent) }
    .wrap{max-width:1080px; margin:0 auto; padding:28px 18px 42px}

    /* ---------- HEADER / HERO ---------- */
    .hero{ position:relative; border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.2)); }
    [data-theme="dark"] .hero{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .header{display:flex;justify-content:space-between;align-items:flex-end;gap:16px}

    /* Brand (logo + name) */
    .brand { display:flex; flex-direction:column; gap:6px }
    .brand-link { display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit }
    .logo-img{ height:44px; width:auto; object-fit:contain; border-radius:10px;
      transition: transform .18s ease, filter .2s ease; }
    .brand-link:hover .logo-img{ transform: rotate(-2deg) scale(1.05); filter: drop-shadow(0 2px 6px rgba(0,0,0,.15)) }

    /* Swap logos by theme (we show only one) */
    .logo-dark{ display:none }
    [data-theme="dark"] .logo-light{ display:none }
    [data-theme="dark"] .logo-dark{ display:inline }

    /* Gradient brand name + underline on hover */
    .brand-name{
      font-family:"Fraunces", serif; font-weight:800; font-size:clamp(22px, 2.6vw, 32px); letter-spacing:.2px;
      background: linear-gradient(90deg,var(--accent),var(--accent-2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .brand-link:hover .brand-name{
      text-decoration: underline; text-decoration-thickness:.12em; text-underline-offset:.18em;
    }

    .tagline{ margin-top:6px; color:var(--muted); font-size:15px; font-style:italic; letter-spacing:.2px }

    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn, .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 14px;border:1px solid var(--border);border-radius:999px;
      background:var(--paper); box-shadow:var(--shadow); color:var(--ink); font-weight:600;
      cursor:pointer;
    }
    .btn:hover, .chip:hover{ transform: translateY(-1px) }

    /* Search chip */
    .search{margin-top:18px}
    .search .chip{ width:100%; max-width:520px; display:flex; align-items:center; gap:10px }
    .search .chip input{ border:0; outline:0; flex:1; background:transparent; color:var(--ink); font-size:15px }

    /* ---------- GRID / CARDS ---------- */
    .content{padding:24px 18px 50px}
    .grid{display:grid; gap:18px; grid-template-columns:1fr}
    @media (min-width:720px){ .grid{grid-template-columns:1fr 1fr} }
    @media (min-width:1100px){ .grid{grid-template-columns:1fr 1fr 1fr} }

    article.card{
      border:1px solid var(--border); border-radius:18px; background:var(--paper);
      overflow:hidden; display:flex; flex-direction:column; box-shadow:var(--shadow);
      transform: translateY(10px) rotate(.2deg); opacity:0; transform-style:preserve-3d;
      transition: transform .5s cubic-bezier(.2,.75,.2,1), opacity .5s, box-shadow .25s;
    }
    article.card.show{ transform: none; opacity:1 }
    article.card:hover{ box-shadow: 0 14px 40px rgba(30,30,30,.12), 0 3px 14px rgba(30,30,30,.06); transform: translateY(-2px) rotateX(.6deg) rotateY(.6deg) }
    [data-theme="dark"] article.card:hover{ box-shadow: 0 14px 40px rgba(0,0,0,.35), 0 3px 14px rgba(0,0,0,.25) }

    .thumb{ aspect-ratio: 4/3; width:100%; background:linear-gradient(135deg, rgba(229,106,166,.18), rgba(106,166,229,.18)) }
    [data-theme="dark"] .thumb{ background:linear-gradient(135deg, rgba(255,155,210,.18), rgba(138,180,255,.18)) }

    /* Blur-up images */
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; filter:blur(8px); transition:filter .35s ease }
    .thumb img[data-loaded="1"]{ filter:blur(0) }

    .pad{ padding:18px 16px 16px }
    h2{
      font-family:"Fraunces", serif; font-weight:800; margin:0 0 8px;
      font-size: clamp(20px, 2.2vw, 24px); line-height:1.25; letter-spacing:.2px;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    .meta{ color:var(--muted); font-size:13px; display:flex; gap:12px; flex-wrap:wrap; margin-bottom:8px }
    .summary{ color:#374151; font-size:15px; display:-webkit-box; -webkit-line-clamp:5; -webkit-box-orient:vertical; overflow:hidden }
    [data-theme="dark"] .summary{ color: #cbd5e1 }

    .badges{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 0 }
    .badge{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:var(--paper) }

    .more{ margin-top:10px; font-weight:700; color:var(--accent) }

    .empty,.error{
      margin:24px 0; border:1px dashed var(--border); border-radius:14px; padding:16px;
      background:rgba(255,255,255,.6); color:#6b7280
    }
    [data-theme="dark"] .empty,[data-theme="dark"] .error{
      background:rgba(255,255,255,.05); color:#93a0b3
    }

    /* ---------- FOOTER (pro) ---------- */
    .site-footer{
      border-top:1px dashed var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,0));
      color:#6b7280; font-size:13px;
    }
    [data-theme="dark"] .site-footer{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
      color:#93a0b3;
    }
    .footer-wrap{ display:flex; align-items:center; justify-content:space-between; gap:16px; padding:18px }
    .f-col{ display:flex; flex-direction:column; gap:6px }
    .f-brand{ display:flex; align-items:center; gap:8px; font-weight:700; color:var(--ink) }
    .f-title{ font-family:"Inter", system-ui; font-weight:700 }
    .f-meta{ font-size:12px }
    .f-links, .f-credits{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .f-logo{ width:18px; height:18px; border-radius:4px; object-fit:contain }
    .f-dark{ display:none }
    [data-theme="dark"] .f-light{ display:none }
    [data-theme="dark"] .f-dark{ display:inline }

    /* ----- About modal styles ----- */
    .about-card{ max-width:720px }
    .about-head{ display:flex; gap:14px; align-items:center; margin-bottom:8px }
    .about-avatar{
      width:64px; height:64px; border-radius:50%; object-fit:cover;
      border:1px solid var(--border); background:var(--paper);
    }
    .about-title{ margin:0; font-family:"Fraunces", serif; font-weight:800 }
    .about-tagline{ margin:.3rem 0 0; color:var(--muted) }
    .about-body{ margin-top:8px }
    .about-cta{ display:flex; gap:10px; flex-wrap:wrap; margin:14px 0 }
    .about-links{ display:flex; gap:10px; flex-wrap:wrap; margin-top:4px }

    /* pill buttons/links reuse */
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--border); border-radius:999px;
      background:var(--paper); color:var(--ink); text-decoration:none; font-weight:600;
    }
    .pill:hover{ transform:translateY(-1px) }
    .pill svg{ opacity:.85 }

    /* ---------- MODALS ---------- */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; padding:20px }
    .modal.open{ display:flex }
    .modal-card{
      max-width:820px; max-height:80vh; overflow:auto; background:var(--paper);
      border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
      padding:22px 22px 26px
    }
    .modal h2{ margin:0 0 10px; font-family:"Fraunces", serif; font-weight:800 }
    .modal .meta{ margin-bottom:14px }
    .modal .body{ font-size:18px; line-height:1.85 }
    .modal .close{ position:sticky; top:0; float:right; margin:-6px -6px 6px 6px;
      border:1px solid var(--border); border-radius:999px; padding:6px 10px; background:transparent; color:var(--ink); cursor:pointer }

    /* Reading progress bar */
    #progress{position:fixed;top:0;left:0;height:3px;width:0;background:var(--accent);z-index:50;transition:width .1s ease}

    /* Tiny “ink” click ripple */
    #ink{position:fixed;pointer-events:none;inset:auto; width:14px;height:14px;border-radius:50%;
      background:radial-gradient(circle at center,var(--accent) 0, transparent 70%); opacity:.0;
      transform:translate(-50%,-50%) scale(.2); transition:opacity .25s, transform .25s; z-index:9999}
    .hidden{display:none!important}

    /* Small screens */
    @media (max-width:720px){
      .footer-wrap{ flex-direction:column; align-items:flex-start }
    }
  </style>
</head>
<body>
  <!-- HERO -->
  <section class="hero">
    <div class="wrap">
      <div class="header">
        <div class="brand">
          <a href="./" class="brand-link">
            <img src="static/logo-light.png" alt="Versesvibez logo" class="logo-img logo-light" />
            <img src="static/logo-dark.png"  alt="Versesvibez logo" class="logo-img logo-dark" />
            <span class="brand-name">{{ site_title or "versesvibez" }}</span>
          </a>
          <div class="tagline">poems • thoughts • little sparks ✨</div>
        </div>
        <div class="actions">
          <button id="themeToggle" class="chip" title="Toggle theme">🌓 Theme</button>
          <button id="aboutBtn" class="btn" title="About">About</button>
          <a class="btn" href="{{ public_url.rstrip('/') + '/subscribe' }}" rel="noopener">Subscribe</a>
        </div>
      </div>

      <div class="search">
        <div class="chip">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18A7.5 7.5 0 1010.5 3a7.5 7.5 0 000 15z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          <input id="q" type="search" placeholder="Search poems (title or text)..." aria-label="Search poems" />
        </div>
      </div>
    </div>
  </section>

  <!-- CONTENT -->
  <main class="content">
    <div id="status" class="empty">Gathering poems from the ether…</div>
    <section id="posts" class="grid" hidden></section>
  </main>

  <!-- FOOTER (pro) -->
  <footer class="site-footer">
    <div class="wrap footer-wrap">
      <div class="f-col">
        <div class="f-brand">
          <img src="static/logo-light.png" class="f-logo f-light" alt="" aria-hidden="true">
          <img src="static/logo-dark.png"  class="f-logo f-dark"  alt="" aria-hidden="true">
          <span class="f-title">{{ site_title or "versesvibez" }}</span>
        </div>
        <div class="f-meta">© {{ generated_at.strftime("%Y") if generated_at else "" }} versesvibez. All rights reserved.</div>
      </div>

      <nav class="f-links">
        <a href="#" id="aboutLink" class="pill">About</a>
        <a href="{{ public_url.rstrip('/') + '/subscribe' }}" class="pill">Subscribe</a>
      </nav>
    </div>
  </footer>

  <!-- Reading mode modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <button class="close" id="modalClose">✕</button>
      <h2 id="mTitle"></h2>
      <div class="meta" id="mMeta"></div>
      <div class="body" id="mBody"></div>
    </div>
  </div>

  <!-- About modal -->
  <div id="about" class="modal" aria-hidden="true">
    <div class="modal-card about-card">
      <button class="close" id="aboutClose" aria-label="Close about">✕</button>

      <div class="about-head">
        <img class="about-avatar" src="static/avatar.jpg" alt="Dami" onerror="this.src='static/logo-light.png'">
        <div>
          <h2 class="about-title">About Dami</h2>
          <p class="about-tagline">I write poems & little sparks. Welcome to my corner of the internet. ✨</p>
        </div>
      </div>

      <div class="about-body">
        <p>
          I explore tenderness, memory, and the tiniest moments that make a day feel alive.
          This site curates my public posts from Substack — collected, searchable, and
          easy to read in one place.
        </p>

        <div class="about-cta">
          <a class="btn" href="{{ public_url.rstrip('/') + '/subscribe' }}" rel="noopener">Subscribe on Substack</a>
          <button id="copyEmail" class="btn" data-email="versesvibez@substack.com">Copy email</button>
        </div>

        <div class="about-links">
          <a href="{{ public_url.rstrip('/') }}" target="_blank" rel="noopener" class="pill">
            <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M3 5h18v2H3V5zm0 4h18v6l-9-3-9 3V9z"/></svg>
            <span>Substack</span>
          </a>
          <a href="mailto:versesvibez@substack.com" class="pill">
            <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M20 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
            <span>Email</span>
          </a>
          <!-- Replace with your real handles -->
          <a href="https://instagram.com/versesvibez" target="_blank" rel="noopener" class="pill">
            <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M7 2h10a5 5 0 015 5v10a5 5 0 01-5 5H7a5 5 0 01-5-5V7a5 5 0 015-5zm5 5a5 5 0 100 10 5 5 0 000-10zm6.5-.9a1.1 1.1 0 110 2.2 1.1 1.1 0 010-2.2zM12 9a3 3 0 110 6 3 3 0 010-6z"/></svg>
            <span>Instagram</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress bar + ink ripple -->
  <div id="progress"></div>
  <div id="ink"></div>

  <script>
    // ----- Theme toggle (persist) -----
    (function(){
      const attr='data-theme', key='vv-theme';
      const saved = localStorage.getItem(key);
      if(saved) document.documentElement.setAttribute(attr, saved);
      document.getElementById('themeToggle').addEventListener('click', ()=>{
        const cur = document.documentElement.getAttribute(attr) || 'light';
        const next = cur === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute(attr, next);
        localStorage.setItem(key, next);
      });
    })();

    // ----- About modal -----
    (function(){
      const about=document.getElementById('about');
      document.getElementById('aboutBtn').onclick=()=>{about.classList.add('open')};
      document.getElementById('aboutClose').onclick=()=>{about.classList.remove('open')};
      document.getElementById('aboutLink')?.addEventListener('click',(e)=>{ e.preventDefault(); about.classList.add('open'); });
      about.addEventListener('click',e=>{ if(e.target===about) about.classList.remove('open'); });
      // Copy email button (with feedback)
      const btn = document.getElementById('copyEmail');
      if(btn){
        btn.addEventListener('click', async ()=>{
          const email = btn.dataset.email || 'versesvibez@substack.com';
          try{
            await navigator.clipboard.writeText(email);
            const old = btn.textContent; btn.textContent = 'Copied ✓'; setTimeout(()=> btn.textContent = old, 1200);
          }catch{ btn.textContent = email; }
        });
      }
    })();

    // ----- Ink ripple -----
    (function(){
      const ink=document.getElementById('ink');
      document.addEventListener('click',(e)=>{
        ink.style.left=e.clientX+'px'; ink.style.top=e.clientY+'px';
        ink.style.opacity=.35; ink.style.transform='translate(-50%,-50%) scale(1)';
        setTimeout(()=>{ink.style.opacity=0; ink.style.transform='translate(-50%,-50%) scale(.2)';},220);
      });
    })();

    // ----- Config from backend -----
    const RSS_URL   = {{ (feed_url or "https://versesvibez.substack.com/feed") | tojson }};
    let WORKER_BASE = {{ (rss_proxy_url or "") | tojson }}; // e.g. https://substack-proxy.X.workers.dev/?rss_url=
    const PUBLIC_BASE = "https://api.rss2json.com/v1/api.json?rss_url=";
    function normalizeBase(b){
      if(!b) return "";
      const hasParam = /[\?&]rss_url=/.test(b);
      if (hasParam) return b;
      const hasQuery = b.includes("?");
      if (!hasQuery) return b + "?rss_url=";
      if (!/[&?]$/.test(b)) b += "&";
      return b + "rss_url=";
    }
    WORKER_BASE = normalizeBase(WORKER_BASE);

    const statusEl = document.getElementById('status');
    const postsEl  = document.getElementById('posts');
    const qEl      = document.getElementById('q');
    const prog     = document.getElementById('progress');

    // ----- Helpers -----
    function strip(html){
      const d=document.createElement('div'); d.innerHTML=html||'';
      d.querySelectorAll('.subscription-widget, .subscription-widget-wrap-editor, .button-wrapper').forEach(n=>n.remove());
      return d.textContent||d.innerText||'';
    }
    function firstImage(html){
      const d=document.createElement('div'); d.innerHTML=html||'';
      const img=d.querySelector('img'); if(img&&img.src) return img.src;
      const source=d.querySelector('source[srcset]');
      if(source){
        const pick=(source.getAttribute('srcset')||'').split(',').map(s=>s.trim().split(' ')[0]).filter(Boolean)[0];
        if(pick) return pick;
      }
      return '';
    }
    function readingTime(text){
      const words=(text.trim().match(/\S+/g)||[]).length;
      return `${Math.max(1, Math.round(words/200))} min read`;
    }
    function vibesFromTitle(title=''){
      const words = (title.toLowerCase().match(/[a-z]{4,}/g)||[]).slice(0,2);
      return [...new Set(words)];
    }

    function makeCard(item, idx){
      const date = item.pubDate ? new Date(item.pubDate) : null;
      const dateStr = date ? date.toLocaleDateString(undefined, {year:'numeric',month:'short',day:'numeric'}) : '';
      const html = item.content || item.description || '';
      const plain = strip(html);
      const img = firstImage(html);
      const snippet = plain.length>260 ? plain.slice(0,260)+'…' : plain;
      const rtime = plain ? readingTime(plain) : '';
      const vibes = vibesFromTitle(item.title).map(v=>`<span class="badge">${v}</span>`).join('');
      const badges = vibes ? `<div class="badges">${vibes}</div>` : '';

      const card=document.createElement('article');
      card.className='card';
      card.style.transitionDelay = `${Math.min(idx, 12) * 45}ms`;
      card.innerHTML = `
        ${img ? `<a class="thumb" href="${item.link}" target="_blank" rel="noopener"><img loading="lazy" src="${img}" alt=""></a>` : `<div class="thumb"></div>`}
        <div class="pad">
          <h2><a href="${item.link}" target="_blank" rel="noopener">${item.title || 'Untitled'}</a></h2>
          <div class="meta">${dateStr ? `<span>${dateStr}</span>`:''}${rtime?`<span>${rtime}</span>`:''}</div>
          <div class="summary">${snippet}</div>
          ${badges}
          <div class="more">
            <a href="${item.link}" target="_blank" rel="noopener">Read on Substack →</a>
            &nbsp;•&nbsp;<a href="#" data-read="1">Quick read</a>
            &nbsp;•&nbsp;<a href="#" data-share="${encodeURIComponent(item.link)}">Share</a>
          </div>
        </div>`;

      // Blur-up handler
      card.querySelectorAll('.thumb img').forEach(imgEl=>{
        if (imgEl.complete) imgEl.setAttribute('data-loaded','1');
        imgEl.addEventListener('load',()=>imgEl.setAttribute('data-loaded','1'));
      });

      // Quick read (modal) opens by index (for keyboard nav)
      card.querySelector('[data-read]')?.addEventListener('click', (e)=>{
        e.preventDefault(); openModalByIndex(idx);
      });

      return card;
    }

    // ----- Modal -----
    const m = {
      el: document.getElementById('modal'),
      title: document.getElementById('mTitle'),
      meta: document.getElementById('mMeta'),
      body: document.getElementById('mBody'),
      close: document.getElementById('modalClose'),
    };
    function openModal(title, dateStr, html){
      m.title.textContent = title || 'Untitled';
      m.meta.textContent  = dateStr || '';
      m.body.innerHTML    = html || '';
      m.el.classList.add('open'); m.el.setAttribute('aria-hidden','false');
      // Reset progress bar
      prog.style.width = '0%';
    }
    function closeModal(){
      m.el.classList.remove('open'); m.el.setAttribute('aria-hidden','true'); m.body.innerHTML='';
      prog.style.width = '0%';
    }
    m.close.addEventListener('click', closeModal);
    m.el.addEventListener('click', e=>{ if(e.target===m.el) closeModal(); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

    // Reading progress bar
    m.body.addEventListener('scroll', ()=>{
      const h = m.body.scrollHeight - m.body.clientHeight;
      const p = h>0 ? (m.body.scrollTop / h) * 100 : 0;
      prog.style.width = p + '%';
    });

    // Keyboard nav inside modal
    function openModalByIndex(i){
      const it = ALL_ITEMS[i]; if(!it) return;
      const d = it.pubDate ? new Date(it.pubDate) : null;
      openModal(it.title, d ? d.toLocaleDateString(undefined, {year:'numeric',month:'short',day:'numeric'}) : '', it.content || it.description || '');
      m.el.dataset.index = i;
    }
    document.addEventListener('keydown', (e)=>{
      if(!m.el.classList.contains('open')) return;
      const i = parseInt(m.el.dataset.index||'0',10);
      if(e.key==='ArrowRight'){ openModalByIndex(Math.min(ALL_ITEMS.length-1, i+1)); }
      if(e.key==='ArrowLeft'){ openModalByIndex(Math.max(0, i-1)); }
    });

    // ----- Share (Web Share API with clipboard fallback) -----
    postsEl.addEventListener('click', async (e)=>{
      const a = e.target.closest('[data-share]');
      if(!a) return;
      e.preventDefault();
      const url = decodeURIComponent(a.getAttribute('data-share'));
      const title = a.closest('.card')?.querySelector('h2')?.textContent?.trim() || 'Poem';
      try{
        if (navigator.share) await navigator.share({title, url});
        else {
          await navigator.clipboard.writeText(url);
          a.textContent = 'Copied ✓'; setTimeout(()=>a.textContent='Share',1200);
        }
      }catch{}
    });

    // ----- Fetch + render (Worker → Public fallback) -----
    async function fetchJSON(url){
      const r=await fetch(url,{credentials:"omit",cache:"no-store"});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    let ALL_ITEMS = [];

    async function load(){
      const workerURL = WORKER_BASE ? WORKER_BASE + encodeURIComponent(RSS_URL) : null;
      const publicURL = PUBLIC_BASE + encodeURIComponent(RSS_URL);
      const attempts = []; if(workerURL) attempts.push(workerURL); attempts.push(publicURL);

      for(const url of attempts){
        try{
          const data = await fetchJSON(url);
          const raw  = (data && Array.isArray(data.items)) ? data.items : [];

          // filter out placeholders / deleted posts
          const items = raw.filter(it => {
            const title = (it.title || '').toLowerCase();
            const text  = (strip(it.content || it.description || '') || '').trim();
            if (/coming\s+soon/i.test(title)) return false;
            if (text.length < 40) return false;
            return true;
          });

          if(items.length){
            ALL_ITEMS = items;
            statusEl.classList.add('hidden');
            postsEl.hidden = false;
            postsEl.innerHTML='';
            items.forEach((it,i)=> {
              const card=makeCard(it,i);
              postsEl.appendChild(card);
              queueMicrotask(()=>card.classList.add('show'));
            });
            return;
          }
        }catch(e){ /* try next */ }
      }
      statusEl.className='error';
      statusEl.textContent='Could not load poems right now. Please try again later.';
    }

    // ----- Search (client-only) -----
    qEl.addEventListener('input', ()=>{
      const q = qEl.value.trim().toLowerCase();
      const cards = postsEl.querySelectorAll('article.card');
      if(!q){ cards.forEach(c=>c.classList.remove('hidden')); return; }
      ALL_ITEMS.forEach((it, i)=>{
        const text = ((it.title||'') + ' ' + (strip(it.content||it.description||''))).toLowerCase();
        cards[i]?.classList.toggle('hidden', !text.includes(q));
      });
    });

    load();
  </script>
</body>
</html>
