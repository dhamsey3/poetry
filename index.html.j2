<!doctype html>
<html lang="en" data-theme="light">
<head>
  {% set STATIC = static_base or './static/' %}
  <meta charset="utf-8" />
  <title>{{ site_title or "Torchborne" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="index,follow" />
  <meta name="description" content="Poetry & musings by Dami." />
  <meta name="color-scheme" content="light dark" />
  <meta id="themeColorMeta" name="theme-color" content="#f59e0b" />
  <link rel="canonical" href="{{ public_url or '' }}" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://api.rss2json.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="preload" as="style" href="{{ STATIC }}styles.css">
  <link id="mainCss" rel="stylesheet" href="{{ STATIC }}styles.css">
  <noscript><link rel="stylesheet" href="{{ STATIC }}styles.css"></noscript>

  <link rel="alternate" type="application/rss+xml" title="{{ site_title or 'Feed' }}" href="{{ feed_url }}" />
  <link rel="icon" type="image/png" sizes="64x64" href="{{ STATIC }}logo-light.png">

  <!-- Open Graph -->
  <meta property="og:title" content="{{ site_title or 'Torchborne' }}" />
  <meta property="og:description" content="Poetry & musings by Dami." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="{{ public_url or '' }}" />
  <meta property="og:image" content="{{ STATICPUB ~ 'logo-light.svg' }}" />
  <meta property="og:site_name" content="{{ site_title or 'Torchborne' }}" />
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="{{ STATICPUB ~ 'logo-light.svg' }}" />

  <!-- Structured Data: site -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"CollectionPage",
    "name": {{ (site_title or "Torchborne") | tojson }},
    "description":"Poetry & musings by Dami.",
    "url": {{ (public_url or '') | tojson }}
  }
  </script>

  <!-- Structured Data: Book (only if Kindle URL present) -->
            {% if featured_ebook %}
              <div class="ebook-cta">
                <a class="btn btn-primary" href="{{ featured_ebook.url }}" target="_blank" rel="noopener">{{ featured_ebook.ctaText or 'Read on Kindle' }}</a>
              </div>
            {% endif %}

  <!-- Relaxed CSP for this static setup -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src 'self' https: data:;
    style-src 'self' 'unsafe-inline' https:;
    font-src https:;
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
    connect-src 'self' https:;
    base-uri 'self';
    form-action 'self';
    upgrade-insecure-requests
  ">
  </head>

<body>
  <a href="#postsGrid" class="visually-hidden" id="skipLink">Skip to posts</a>
  <div id="noJsBanner" class="status error" role="alert" hidden>JavaScript is disabled. Some features (search, quick read) won't work. You can still read directly on Substack via the links below.</div>
  <noscript><style>#noJsBanner,#noJsBanner[hidden]{display:block!important}</style></noscript>

  <!-- Floating Shapes -->
  <div class="floating-shapes" aria-hidden="true">
    <div class="shape accent"></div>
    <div class="shape accent-2"></div>
    <div class="shape accent-3"></div>
  </div>

  <!-- Particles -->
  <div class="particles" id="particles" aria-hidden="true"></div>

  <!-- Progress Bar -->
  <div class="progress-bar" id="progressBar" role="progressbar" aria-live="off" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
  <div id="appRoot" class="main-content" aria-hidden="false">
    <!-- HERO -->
    <section class="hero">
      <div class="wrap">
        <div class="hero-content">
          <div class="brand-section">
            <a href="./" class="brand-link">
              <img src="{{ STATIC }}logo-light.svg" alt="Torchborne logo" class="logo-img logo-light" fetchpriority="high" width="64" height="64" />
              <img src="{{ STATIC }}logo-dark.svg" alt="Torchborne logo" class="logo-img logo-dark" fetchpriority="high" width="64" height="64" />
              <h1 class="brand-name">{{ site_title or 'Torchborne' }}</h1>
            </a>
            <div class="hero-tagline" aria-live="polite">where words carry the flame ‚ú®</div>
          </div>

          <div class="hero-actions">
            <button id="themeToggle" class="chip accent" title="Toggle theme" aria-pressed="false"><span id="themeIcon" aria-hidden="true">üåì</span> <span id="themeText">Theme</span></button>
            <button id="refreshBtn" class="chip accent" title="Refresh posts">‚Üª Refresh</button>
            <button id="randomBtn" class="chip accent" title="Surprise me"><span>üé≤</span> Random</button>
            <button id="aboutBtn" class="btn" title="About" aria-haspopup="dialog" aria-controls="aboutModal"><span>üëã</span> About</button>
            <a class="btn btn-primary" href="{{ SUBSCRIBE_URL }}" rel="noopener"><span>üíå</span> Subscribe</a>
          </div>

          <div class="search-section">
            <div class="search-wrapper">
              <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18A7.5 7.5 0 1010.5 3a7.5 7.5 0 000 15z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
              <input id="searchInput" type="search" class="search-input" placeholder="Search through poems and musings..." aria-label="Search poems" />
            </div>
            <!-- NEW: Tag filter chips -->
            <div id="tagFilters" class="filter-chips" aria-label="Filter poems by tag"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- MAIN CONTENT -->
    <main class="content">
      <div class="wrap">

        <!-- PINNED EBOOK (shows only if Kindle URL is set) -->
        

        <div id="statusMessage" class="status" role="status" aria-live="polite">
          Gathering poems from the digital ether...
        </div>

        <section id="postsGrid" class="posts-grid" hidden>
          
        </section>

        <button id="loadMore" class="chip accent" style="display:none; margin: 24px auto 0;" aria-controls="postsGrid">Load older poems</button>
      </div>
    </main>

    <!-- FOOTER -->
    <footer class="footer">
      <div class="wrap">
        <div class="footer-content">
          <div class="footer-brand">
            <img src="{{ STATIC }}logo-light.svg" class="footer-logo logo-light" alt="" aria-hidden="true" width="32" height="32">
            <img src="{{ STATIC }}logo-dark.svg" class="footer-logo logo-dark" alt="" aria-hidden="true" width="32" height="32">
            <div class="footer-info">
              <h3>{{ site_title or 'torchborne' }}</h3>
              <div class="footerCopyright">¬© {{ generated_at.year }} ‚Ä¢ Made with ‚ù§Ô∏è and pixels</div>
            </div>
          </div>

          <nav class="footer-links" aria-label="Footer">
            <a href="#" id="footerAboutLink" class="pill">About</a>
            <a href="{{ SUBSCRIBE_URL }}" class="pill">Subscribe</a>
            <a href="{{ POSTS_BASE }}" target="_blank" rel="noopener noreferrer nofollow external" class="pill">
              <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M3 5h18v2H3V5zm0 4h18v6l-9-3-9 3V9z"/></svg>
              Substack
            </a>
          </nav>
        </div>
      </div>
    </footer>
  </div>

  <!-- READING MODAL -->
  <div id="readingModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalBody" tabindex="-1" hidden>
    <div class="modal-content">
      <button class="modal-close" id="readingModalClose" aria-label="Close">‚úï</button>
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle"></h2>
        <div class="modal-meta" id="modalMeta"></div>
        <div class="modal-actions">
          <button id="prevPost" class="chip accent" title="Previous (‚Üê)">‚Üê Prev</button>
          <button id="nextPost" class="chip accent" title="Next (‚Üí)">Next ‚Üí</button>
        </div>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- ABOUT MODAL -->
  <div id="aboutModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="aboutTitle" tabindex="-1" hidden>
    <div class="modal-content">
      <button class="modal-close" id="aboutModalClose" aria-label="Close about">‚úï</button>
      <div class="modal-header">
      <div class="about-header">
        <img class="about-avatar" src="{{ STATIC }}avatar.jpg" alt="{{ site_title or 'Torchborne' }}" onerror="this.src='{{ STATIC }}logo-light.svg'">
        <div class="about-info">
          <h2 id="aboutTitle">About {{ site_title or 'Torchborne' }}</h2>
          <p class="about-tagline">Illuminating poetry, carrying the flame of words ‚ú®</p>
        </div>
      </div>
      <div class="about-body">
        <p>Welcome to my little corner of the internet where I explore the tender spaces between thoughts and feelings. Here you'll find poems, musings, and little sparks of inspiration that dance through everyday moments.</p>
      </div>
    </div>
  </div>

  <!-- DOMPurify and initial posts data -->
  <script id="initialPostsData" type="application/json">{{ (posts or []) | tojson }}</script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"
          integrity="sha384-OLBgp1GsljhM2TJ+sbHjaiH9txEUvgdDTAzHv2P24donTt6/529l+9Ua0vFImLlb"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Runtime config for client JS (populated from template variables) -->
  <script>
    window.SITE_CONFIG = {
      RSS_URL: {{ (feed_url or "https://versesvibez.substack.com/feed") | tojson }},
      WORKER_BASE: {{ (rss_proxy_url or "") | tojson }},
      RSS2JSON_KEY: {{ (rss2json_api_key or "") | tojson }},
      MAX_ITEMS: {{ (max_items or 50) | tojson }},
      POSTS_BASE: {{ (POSTS_BASE or "https://versesvibez.substack.com/") | tojson }},
      STATIC_DATA_URL: './data/posts.json',
      FEATURED_EBOOK: {{ (featured or {}) | tojson }},
      TAGLINES: ["where words carry the flame ‚ú®","poetry for wandering souls ‚úçÔ∏è","verses that glow in the dark üåô"]
    };
  </script>

  <!-- Load public JS (extracted from template for maintainability) -->
  <script src="{{ STATIC }}js/main.js" defer></script>
</body>
</html>
